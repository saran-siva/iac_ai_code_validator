name: Terraform Validator (LLM-based)

on:
  pull_request:
    branches:
      - main      # Trigger when PR targets master
    types: [opened, synchronize, reopened]

jobs:
  validate-terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama service
        run: |
          sudo systemctl start ollama
          sleep 5

      - name: Pull Llama 3.2 model
        run: ollama pull llama3.2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install requirements
        run: pip install ollama

      - name: Run Terraform Validator
        id: validator
        run: |
          python scripts/chat_agent.py terraform/sample.tf > validation_output.txt
          echo "=== VALIDATION RESULT BELOW ==="
          cat validation_output.txt

      - name: Check if Terraform code passed validation
        run: |
          if grep -qi "FAIL" validation_output.txt; then
            echo "❌ Terraform validation failed. Blocking merge."
            exit 1
          else
            echo "✅ Terraform validation passed."
          fi
